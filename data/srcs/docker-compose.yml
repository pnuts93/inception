version: '3.8'

services:
  web:
    depends_on:
      - wp
    image: nginx
    build: ./requirements/nginx
    ports:
      - 443:443
    volumes:
      - /home/pnuti/data/v_wordpress:/var/www/html
      - ./requirements/nginx/conf:/etc/nginx/nginx.conf:ro
    environment:
      - DOMAIN_NAME
    networks:
      - webserver
    restart: unless-stopped

  wp:
    depends_on:
      - db
    image: wordpress
    build: ./requirements/wordpress
    ports:
      - 127.0.0.1:9000:9000
    volumes:
      - /home/pnuti/data/v_wordpress:/var/www/html
      - ./requirements/wordpress/tools/php-fpm.conf:/etc/php7/php-fpm.conf:ro
      - ./requirements/wordpress/tools/www.conf:/etc/php7/php-fpm.d/www.conf:ro
    environment:
      - WORDPRESS_DB_HOST
      - WORDPRESS_DB_USER
      - WORDPRESS_DB_PASSWORD
      - WORDPRESS_DB_NAME
      - WORDPRESS_ADMIN_USER
      - WORDPRESS_ADMIN_PASSWORD
      - WORDPRESS_ADMIN_EMAIL
      - WORDPRESS_USER_NAME
      - WORDPRESS_USER_PASSWORD
      - WORDPRESS_USER_EMAIL
    networks:
      - webserver
      - wp
    restart: unless-stopped

  db:
    image: mariadb
    build: ./requirements/mariadb
    ports:
      - 127.0.0.1:3306:3306
    volumes:
      - /home/pnuti/data/v_mariadb:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD
      - MYSQL_DATABASE
      - MYSQL_USER
      - MYSQL_PASSWORD
    networks:
      - wp
    restart: unless-stopped
  
  redis-cache:
    depends_on:
      - wp
    image: redis
    build: ./requirements/redis
    ports:
      - 127.0.0.1:6379:6379
    volumes:
      - ./requirements/redis/tools/redis.conf:/etc/redis.conf:ro
    networks:
      - wp
    restart: unless-stopped

  ftp:
    depends_on:
      - wp
    image: ftp
    build: ./requirements/ftp
    ports:
      - 0.0.0.0:20:20
      - 0.0.0.0:21:21
      - 990:990
      - 50000-51000:50000-51000
    volumes:
      - /home/pnuti/data/v_wordpress:/data/
      - ./requirements/ftp/tools/vsftpd.conf:/etc/vsftpd/vsftpd.conf
    environment:
      - FTP_USER
      - FTP_PASSWD
    networks:
      - ftp
    restart: unless-stopped

networks:
  webserver:
  wp:
  ftp:

volumes:
  v_mariadb:
    name: v_mariadb
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /home/pnuti/data/v_mariadb
  v_wordpress:
    name: v_wordpress
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /home/pnuti/data/v_wordpress
